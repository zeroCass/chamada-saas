{% extends "base.jinja2" %}
{% block head %}
    {{ super() }}
    <script src="{{ url_for('static', filename='html5-qrcode.min.js') }}"></script>
{% endblock %}
{% block content %}
<div class="container">
    <h1>QRCODE</h1>
    <div id="reader" width="600px"></div>
    <div id="result"></div>
    <div id="error"></div>
</div>
<script>

    function onScanSuccess(decodedText, decodedResult) {
        // Handle the scanned code as you like
        console.log(`Code matched = ${decodedText}`, decodedResult)
        
        // Make an HTTP POST request to the Flask route
        fetch('/qrcode', {
            method: 'POST',
            headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `decoded_text=${encodeURIComponent(decodedText)}`
        })
        .then(response => response.json())
        .then(data => {
            // handle the response of the flask application {status: status}
            console.log('data:', data)
            // redirect the user to another page
            if (data.status === "sucess") {
                window.location.href = '/'
            }
        })
        .catch(error => {
            // Handle the error if necessary
            console.error('Error:', error)
        })
        .finally(() => {
            //clear the canvas and removes the reader element
            html5QrcodeScanner.clear()
            document.getElementById("reader").remove()
        })
        /*document.getElementById("result").innerHTML = `
        <h2>Sucesso</h2>
        <p>${decodedText}</p>
        `
        html5QrcodeScanner.clear()
        document.getElementById("render").remove()*/
    }

    function onScanFailure(error) {
        // Handle scan failure
        console.warn(`Code scan error = ${error}`)
    }

    function startScanning(cameraId) {
        const html5QrCode = new Html5Qrcode("reader")
        const config = { fps: 10, qrbox: { width: 250, height: 250 } }
        html5QrCode.start(cameraId, config, onScanSuccess, onScanFailure)
    }

    
    // Request camera permission and start scanning
    Html5Qrcode.getCameras()
    .then(devices => {
        // devices would be an array of objects of type:
        // { id: "id", label: "label" }

        // check for back cameras prefer
        const backCamera = devices.find(device => device.label.includes('back'))
         if (backCamera) {
            const backCameraId = backCamera.id
            startScanning(backCameraId)
        } else {
            startScanning(devices[0].id)
        }
        
    })
    .catch(error => {
        // Handle camera permission error
        console.error('Camera Permission Error:', error);
        // Show an error message to the user
        const errorMessage = 'Camera access denied. Unable to start QR code scanning.';
        // Display the error message on the page
        const errorElement = document.getElementById('error')
        errorElement.textContent = errorMessage
    })
</script>
{% endblock %}
